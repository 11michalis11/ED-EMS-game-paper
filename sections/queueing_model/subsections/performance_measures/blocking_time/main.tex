\subsubsection{Blocking time}

% TODO: Possibly replace the contents of this section with the ones for the 
% closed form formula of the blocking time
% Currently the direct approach one is shown

Unlike the waiting time, the blocking time is only calculated for individuals of
the second type.  
That is because individuals of the first type cannot be blocked. 
Thus, one only needs to consider the pathway of type 2 individuals to get the 
mean blocking time of the system. 
The set of states where individuals can be blocked is defined as:

\begin{equation} \label{eq:set_of_blocking_states}
    S_b = \{(u,v) \in S \; | \; u > 0\}
\end{equation}
 
In order to not consider individuals that will be lost to the system, the set of 
accepting states needs to be taken into consideration. 
As defined in section \ref{sec:waiting_time}, the set of accepting states is 
given by (\ref{eq:accepting_states_type_2}):

\begin{equation*}
    S_A^{(2)}=
    \begin{cases}
        \{(u, v) \in S \; | \; u < M \} & \textbf{if } T \leq N\\
        \{(u, v) \in S \; | \; v < N \} & \textbf{otherwise}
    \end{cases}
\end{equation*}

The mean sojourn time for each state is given by the inverse of the out-flow of
that state.
However, whenever a type 2 individual arrives at the system, no subsequent 
arrival of another type 2 individual can affect its pathway or total time in 
the system.
Therefore, looking at the mean time in the system from the perspective of an 
individual of the second type, all such type 2 arrivals need to be ignored.
Note here that this is not the case for individuals of the first type.
Whenever a type 2 individual is blocked and a type 1 individual arrives the type
2 individuals will remain blocked for some additional amount of time.
Thus, the mean time that a type 2 individual spends at each state is given by:

\begin{equation}\label{eq:time_in_state_blocking_time}
    c(u,v) = 
    \begin{cases}
        \frac{1}{\min(v,C) \mu}, & \text{if } v = N\\
        \frac{1}{\lambda_1 + \min(v,C) \mu}, & \text{otherwise}
    \end{cases}
\end{equation}
 
In equation (\ref{eq:time_in_state_blocking_time}), both service completions and 
type 1 arrivals are considered. 
Thus, from a blocked individual's perspective whenever the system moves from one 
state \((u,v)\)
to another state it can either:

\begin{itemize}
    \item be because of a service being completed: we will denote the probability 
    of this happening by \(p_s(u,v)\). 
    \item be because of an arrival of an individual of type 1: denoting such 
    probability by \(p_o(u,v)\).
\end{itemize}
The probabilities are given by:

\begin{equation*}
    p_s(u,v) = \frac{\min(v,C)\mu}{\lambda_1 + \min(v,C)\mu}, \qquad
    p_o(u,v) = \frac{\lambda_1}{\lambda_1 + \min(v,C)\mu}
\end{equation*}


Having defined \(c(u,v)\) and \(S_b\) a formula for the blocking time that is
expected to occur at each state can be given by:

\begin{equation}\label{eq:general_blocking_time_at_each_state}
    b(u,v) = 
    \begin{cases} 
        0, & \textbf{if } (u,v) \notin S_b \\
        c(u,v) + b(u - 1, v), & \textbf{if } v = N = T\\
        c(u,v) + b(u, v-1), & \textbf{if } v = N \neq T \\
        c(u,v) + p_s(u,v) b(u-1, v) + p_o(u,v) b(u, v+1), & \textbf{if } u > 0 
        \textbf{ and } \vspace{-0.2cm} \\ 
        & \quad v = T \\
        c(u,v) + p_s(u,v) b(u, v-1) + p_o(u,v) b(u, v+1), & \textbf{otherwise} \\
    \end{cases}
\end{equation}

A direct approach will be used to solve this equation here. 
By enumerating all equations of ((\ref{eq:general_blocking_time_at_each_state})) 
for all states \((u,v)\) that belong in \(S_b\) 
a system of linear equations arises where the unknown variables are all the 
\(b(u,v)\) terms. 
Note here that these equations correspond to all blocking states as defined in
(\ref{eq:set_of_blocking_states}). 
Equations that correspond to non-blocking states have a value of \(0\) as 
defined in (\ref{eq:general_blocking_time_at_each_state})
The general form of the equation in terms of \(C,T,N \text{ and } M\) is given by: 

\begin{align}
    b(1,T) \quad &= \quad c(1, T) + p_o b(1, T + 1) \label{eq:first_eq_of_blocking_general}\\
    b(1,T + 1) \quad &= \quad c(1, T + 1) + p_s b(1, T) + p_o b(1, T + 1) \\
    b(1,T + 2) \quad &= \quad c(1, T + 2) + p_s b(1, T + 1) + p_o b(1, T + 3) \\
    & \ \, \vdots \nonumber \\
    b(1, N) \quad &= \quad c(1, N) + b(1, N - 1) \\
    b(2, T) \quad &= \quad c(2, T) + p_s b(1, T) + p_o b(2, T + 1) \\
    b(2, T + 1) \quad &= \quad c(2, T + 1) + p_s b(2, T) + p_o b(2, T + 2) \\
    & \ \, \vdots \nonumber \\
    b(M - 1, N) \quad &= \quad c(M, N - 1) + b(M, N-1) \\ 
    b(M, T) \quad &= \quad c(T, N) + p_s b(T-1, N) + p_o b(T, N+1) \\
    & \ \, \vdots \nonumber \\
    b(M, N) \quad &= \quad c(M, N) + b(M, N-1) \label{eq:last_eq_of_blocking_general}
\end{align}

The equivalent matrix notation of the linear system of equations 
((\ref{eq:first_eq_of_blocking_general})) - ((\ref{eq:last_eq_of_blocking_general}))
is given by \(Zx=y\), where:
\begin{equation}\label{eq:general_algebaric_approach_blocking_time}
    \scalebox{0.73}{\(
        Z = 
        \begin{pmatrix}
            -1 & p_o & 0 & \dots & 0 & 0 & 0 & 0 & 0 & \dots & 0 & 0 \\ %(1,T)
            p_s & -1 & p_o & \dots & 0 & 0 & 0 & 0 & 0 & \dots & 0 & 0 \\ %(1,T+1)
            0 & p_s & -1 & \dots & 0 & 0 & 0 & 0 & 0 & \dots & 0 & 0 \\ %(1,T+2)
            \vdots & \vdots & \vdots & \ddots & \vdots & \vdots & \vdots & 
            \vdots & \vdots & \ddots & \vdots & \vdots \\ 
            0 & 0 & 0 & \dots & 1 & -1 & 0 & 0 & 0 & \dots & 0 & 0 \\ %(1,N)
            p_s & 0 & 0 & \dots & 0 & 0 & -1 & p_o & 0 & \dots & 0 & 0 \\ %(2,T)
            0 & 0 & 0 & \dots & 0 & 0 & p_s & -1 & p_o & \dots & 0 & 0 \\ %(2,T+1)
            \vdots & \vdots & \vdots & \ddots & \vdots & \vdots & \vdots & 
            \vdots & \vdots & \ddots & \vdots & \vdots \\ 
            0 & 0 & 0 & \dots & 0 & 0 & 0 & 0 & 0 & \dots & 1 & -1 \\ %(M,N)
        \end{pmatrix},
        x = 
        \begin{pmatrix}
            b(1,T) \\
            b(1,T+1) \\
            b(1,T+2) \\
            \vdots \\
            b(1,N) \\
            b(2,T) \\
            b(2,T+1) \\
            \vdots \\
            b(M,N) \\
        \end{pmatrix}, 
        y= 
        \begin{pmatrix}
            -c(1,T) \\
            -c(1,T+1) \\
            -c(1,T+2) \\
            \vdots \\
            -c(1,N) \\
            -c(2,T) \\
            -c(2,T+1) \\
            \vdots \\
            -c(M,N) \\
        \end{pmatrix}
    \)}
\end{equation}

Thus, having calculated the mean blocking time for all blocking states \(b(u,v)\), 
it only remains to put them together in a formula.
The resultant formula for the mean blocking time is given by:

\begin{equation}\label{eq:algebraic_blocking_time}
    B = \frac{\sum_{(u,v) \in S_A} \pi_{(u,v)} \; b(u,v)}{\sum_{(u,v) \in S_A} 
    \pi_{(u,v)}}
\end{equation}



To illustrate how the described formula works consider a Markov model where 
\(C=2, T=2, N=4, M=2\) (figure \ref{fig:example_algeb_blocking}). 
The equations that correspond to such a model are shown in 
((\ref{eq:first_eq_of_blocking_example}))-((\ref{eq:last_eq_of_blocking_example})) 
and their equivalent matrix notation form is shown in 
(\ref{eq:example_algebaric_approach_blocking_time}).

\begin{minipage}{.5\textwidth}
    \begin{figure}[H]
        \scalebox{0.6}{\input{imgs/example_2242/main.tex}}
        \caption{
            \centering{Example of Markov chain with \(C=2, T=2, N=4, M=2\)}
        }
        \label{fig:example_algeb_blocking}
    \end{figure}
\end{minipage}
\begin{minipage}{.43\textwidth}
    \begin{align}
        b(1,2) &= c(1,2) + p_o b(1,3) \label{eq:first_eq_of_blocking_example} \\
        b(1,3) &= c(1,3) + p_s b(1,2) \nonumber \\ &+ p_o b(1,4) \\
        b(1,4) &= c(1,4) + b(1,3) \\
        b(2,2) &= c(2,2) + p_s b(1,2) \nonumber \\ &+ p_o b(2,3) \\
        b(2,3) &= c(2,3) + p_s b(2,2) \nonumber \\ &+ p_o b(1,4) \\
        b(2,4) &= c(2,4) + b(2,3) \label{eq:last_eq_of_blocking_example}
    \end{align}
\end{minipage}

\begin{equation}\label{eq:example_algebaric_approach_blocking_time}
    Z=
    \begin{pmatrix}
        -1 & p_o & 0 & 0 & 0 & 0 \\ %(1,2)
        p_s & -1 & p_o & 0 & 0 & 0 \\ %(1,3)
        0 & 1 & -1 & 0 & 0 & 0 \\ %(1,4)
        p_s & 0 & 0 & -1 & p_o & 0\\ %(2,2)
        0 & 0 & 0 & p_s & -1 & p_o \\ %(2,3)
        0 & 0 & 0 & 0 & 1 & -1 \\ %(2,4)
    \end{pmatrix},
    x=
    \begin{pmatrix}
        b(1,2) \\
        b(1,3) \\
        b(1,4) \\
        b(2,2) \\
        b(2,3) \\
        b(2,4) \\
    \end{pmatrix}, 
    y=
    \begin{pmatrix}
        -c(1,2) \\
        -c(1,3) \\
        -c(1,4) \\
        -c(2,2) \\
        -c(2,3) \\
        -c(2,4) \\
    \end{pmatrix}
\end{equation}
